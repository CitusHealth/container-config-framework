# Container Configuration Framework (CCF)

The **Container Configuration Framework** (**CCF**) is an opionated approach to generating container 
configuration files that can then be loaded into Docker, AWS ECR/ECS, and other engines.

CCF uses [Jsonnet](https://jsonnet.org/) as the core configuration language and generates appropriate
Dockerfile, docker-compose.yml, and related artifacts.

Prerequisites:

* Linux server
* user with sudo privileges and Docker permissions

Useful environment variables:

* **CCF_HOME**: defaults to /opt/container-config-framework
* **JSONNET_PATH**: defaults to $(HOME)/.ccf/secrets:$(HOME)/.ccf/open:$(CCF_HOME)/etc

Intial setup:

    curl https://raw.githubusercontent.com/shah/container-config-framework/master/bin/setup-CCF.sh | bash

To upgrade:

    cd /opt/container-config-framework
    sudo git pull

    cd lib
    make check-dependencies

## Conventions

CCF manages Docker containers using git, make, and [Jsonnet](https://jsonnet.org/). All developers looking
to extend CCF need to know those tools very well. The framework manages containers by an *opinionated* set 
of *conventions*:

Each container is defined by files in a *container definition home* ("CDH") directory. The CDH can be placed
anywhere but follows these conventions:

* The *name* of the **CDH** directory is assumed to be the container name.
* Each **CDH** directory contains, at a minium, a container.ccf-defn.jsonnet config file.
* Each **CDH** directory contains a .gitignore file which is auto-generated by the Makefile
  and makes sure that no git tracking occurs for files generated by Jsonnet.
* The CDH directory's Makefile feeds Jsonnet a container.ccf-defn.jsonnet and generates all necessary
  Docker artifacts.

## Scripts

* **CCF_HOME/bin/ccfmake** is a convenience script to run the Makefile in a **CDH** if CCF_HOME/lib/Makefile 
  is not symlink'd. This script is symlink'd as /usr/bin/ccfmake by the installer.
* **CCF_HOME/bin/ccfinit** is a convenience script to download container definition files from a common repo.
  This script is symlink'd as /usr/bin/ccfmake by the installer.

## Container Makefile

Each container definition home ("CDH") directory may contain a Makefile which is, usually, symlink'd to
CCF_HOME/lib/Makefile. This allows each container to have it's own Makefile but conveniently
links to a master Makefile unless the container has something special.

If the CDH does not contain a Makefile, then the ccfmake convenience script may be used as a replacement.

The Makefile has a simple plugin model:

* If a file named **after_configure.make-plugin.sh** exists in the container definition home directory,
  it is run right after the Makefile's configure target (after generating all artifacts).
* If a file named **container.make.inc** exists in the container definition home directory, it is
  included in the Makefile -- effectively allowing you to add targets. You can also redefine targets
  but you'll get a warning.
* If a file named **after_start.make-plugin.sh** exists in the container definition home directory, it
  is run immediately after the make start target concludes. This allows you to run some post-start
  functionality like checking the health of a container or ensuring other dependencies are executed.

The Makefile has these typical targets:

* **help** shows all the targets available in the Makefile -- use that instead of this document when possible
* **check-dependencies** evaluates the runtime environment to see if there's anything missing
* **build** builds the container using Dockerfile in this directory (if no Dockerfile, this target is ignored)
* **configure** generates the container's artifacts (driven by container.ccf-defn.jsonnet), then runs the
  **after_configure.make-plugin.sh** shell script (if it exists)
* **start** runs configure, then starts the container and all dependencies
* **inspect** inspects a running container's settings, volumes, etc.
* **logs** shows the logs in the container
* **ports** shows the container's mapped ports
* **stop** stops the container but retain volumes and generated files
* **kill** stops the container and **DESTRUCTIVELY** removes networks, volumes, etc. but leaves generated files
* **clean** stops the container and **DESTRUCTIVELY** cleans up generated files, networks, volumes, etc.

The Makefile generates these files:

* **.ccf_container.ccf-defn.jsonnet_generated**, a text file that contains the list of files generated
* **.ccf_delete_generated_files.sh**, which is executed by the **clean** target
* **.gitignore**, to make sure generated files are not tracked or committed

## Configuration Files

CCF generates Dockerfile, docker-compose.yml, and a variety of other configuration files using Makefiles
and the [Jsonnet data templating language](https://jsonnet.org/). When Jsonnet runs, it uses the 
JSONNET_PATH Makefile variable defined in CCF_HOME/lib/container-conf/Makefile, but it can be overridden.
