# Container Configuration Framework (CCF)

The **Container Configuration Framework** (**CCF**) is an opionated approach to generating container 
configuration files that can then be loaded into Docker, AWS ECR/ECS, and other engines.

CCF uses [Jsonnet](https://jsonnet.org/) as the core configuration language and generates appropriate
Dockerfile, docker-compose.yml, and related artifacts.

Prerequisites:

* Linux server
* user with sudo privileges and Docker permissions

Intial setup:

    curl https://raw.githubusercontent.com/shah/container-config-framework/master/bin/setup-CCF.sh | bash

To upgrade:

    cd /opt/container-config-framework
    sudo git pull

    cd /usr/lib/container-conf
    make check-dependencies

## Conventions

CCF manages Docker containers using git, make, and [Jsonnet](https://jsonnet.org/). All developers looking
to extend CCF need to know those tools very well. The framework manages containers by an *opinionated* set 
of *conventions*:

* The /etc/ccf, /usr/lib/ccf directories are special
* Other than the special directories mentioned above, all other directories are a *container* definition
  home ("CDH") directory.
* The name of the **CDH** directory is assumed to be the container name
* Each **CDH** directory symbolically links a Makefile to /usr/lib/container-conf/Makefile.
* Each **CDH** directory contains, at a minium, a container.defn.jsonnet config file
* Each **CDH** directory contains a .gitignore file which is auto-generated by the Makefile
  and makes sure that no git tracking occurs for files generated by Jsonnet.
* The CDH directory's Makefile feeds Jsonnet a container.defn.jsonnet and generates all necessary
  Docker artifacts.

## Container Makefile

Each container definition home directory contains a Makefile which is, usually, symlink'd to
/usr/lib/container-conf/Makefile. This allows each container to have it's own Makefile but conveniently
links to a master Makefile unless the container has something special.

The Makefile has a simple plugin model:

* If a file named **after_configure.make-plugin.sh** exists in the container definition home directory,
  it is run right after the Makefile's configure target (after generating all artifacts).
* If a file named **container.make.inc** exists in the container definition home directory, it is
  included in the Makefile -- effectively allowing you to add targets. You can also redefine targets
  but you'll get a warning.
* If a file named **after_start.make-plugin.sh** exists in the container definition home directory, it
  is run immediately after the make start target concludes. This allows you to run some post-start
  functionality like checking the health of a container or ensuring other dependencies are executed.

The Makefile has these typical targets:

* **help** shows all the targets available in the Makefile -- use that instead of this document when possible
* **check-dependencies** evaluates the runtime environment to see if there's anything missing
* **build** builds the container using Dockerfile in this directory (if no Dockerfile, this target is ignored)
* **configure** generates the container's artifacts (driven by container.defn.jsonnet), then runs the
  **after_configure.make-plugin.sh** shell script (if it exists)
* **start** runs configure, then starts the container and all dependencies
* **inspect** inspects a running container's settings, volumes, etc.
* **logs** shows the logs in the container
* **ports** shows the container's mapped ports
* **stop** stops the container but retain volumes and generated files
* **kill** stops the container and **DESTRUCTIVELY** removes networks, volumes, etc. but leaves generated files
* **clean** stops the container and **DESTRUCTIVELY** cleans up generated files, networks, volumes, etc.

The Makefile generates these files:

* **.container.defn.jsonnet_generated**, a text file that contains the list of files generated
* **.gitignore**, to make sure generated files are not tracked or committed
* **.delete_generated_files.sh**, to make sure generated files are not tracked or committed

## Configuration Files

CCF generates Dockerfile, docker-compose.yml, and a variety of other configuration files using Makefiles
and the [Jsonnet data templating language](https://jsonnet.org/). When Jsonnet runs, it uses the 
JSONNET_PATH Makefile variable defined in /usr/lib/container-conf/Makefile, but it can be overridden.
